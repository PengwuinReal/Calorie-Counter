<!DOCTYPE html>
<html>
    <head>
        <title>Stats</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" type="text/css">
    </head>
    <body>
        <div class="tabs">
            <a href="{{ url_for('home') }}"><button>Home</button></a>
            <a href="{{ url_for('tdee_calculator') }}"><button>TDEE Calculator</button></a>
            <a href="{{ url_for('stats') }}"><button>Stats</button></a>
            <a href="{{ url_for('camera') }}"><button>Camera</button></a>
        </div>
        <div class="page">
            <div id="goalTracker">
            <label for="dailyGoal"><strong>Daily Calorie Goal (kcal):</strong></label>
            <input type="number" id="dailyGoal" placeholder="e.g. 2000" />
            <button onclick="saveGoal()">Save Goal</button>
            <p id="goalStatus"></p>
            </div>

            <button id="refreshStatsBtn">Refresh</button>
            <button id="clearDataBtn">Clear Data</button>
            <div id="totals"></div>
            <div id="classificationResult"></div>


        </div>
        
        <script>
            let totalCal = 0;
            let totalProtein = 0;
            let totalFat = 0;
            let totalCarbs = 0;

            function saveGoal() {
                const goal = document.getElementById("dailyGoal").value;
                localStorage.setItem("calorieGoal", goal);
                updateGoalStatus();
            }

            function updateGoalStatus() {
                const goal = parseInt(localStorage.getItem("calorieGoal"));
                const goalStatus = document.getElementById("goalStatus");

                if (!goal || isNaN(goal)) {
                    goalStatus.innerText = "No daily goal set.";
                } else {
                    const percent = ((totalCal / goal) * 100).toFixed(1);
                    goalStatus.innerText = `You've consumed ${totalCal} of ${goal} kcal (${percent}%).`;
                }
            }

            async function refreshStats(){
                totalCal = 0;
                totalProtein = 0;
                totalFat = 0;
                totalCarbs = 0;

                try {
                    resultContainer = document.getElementById('classificationResult');
                    resultContainer.innerHTML = '<div id="classificationResult"></div>';
                    const calRes = await fetch('/load_statistics', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: 'yo we did it'
                    });
                    const statsJson = await calRes.json();
                    
                    k = 0;
                    while (true){
                        if (!(k.toString() in statsJson)) break;

                        calData = statsJson[k.toString()];
                        if (calData.success) {
                            const nutrition = calData.nutrition;
                            resultContainer.innerHTML += `
                                <div class="calorie-info">
                                    <p><strong>Calories:</strong> ${nutrition.calories || '--------'} kcal</p>
                                    <p><strong>Info:</strong> ${nutrition.summary || '---------'}</p>
                                    ${nutrition.image ? `<img src="${nutrition.image}" style="max-width: 200px; border-radius: 8px;">` : ''}
                                    <p><strong>Time:</strong> ${calData.timestamp || 'Time not found'}</p>
                                </div>
                            `;
                            totalCal += nutrition.calories || 0;
                            totalProtein += nutrition.protein || 0;
                            totalFat += nutrition.fat || 0;
                            totalCarbs += nutrition.carbs || 0;
                        } else {
                            resultContainer.innerHTML += `<p class="error">Calorie info unavailable: ${calData.error}</p>`;
                        }
                        k += 1;
                    }

                } catch (error) {
                    console.error('Error classifying food:', error);
                    resultContainer.innerHTML = `
                        <div class="classification-error">
                            <h4>Classification Failed</h4>
                            <p>Error: ${error.message}</p>
                        </div>
                    `;
                } 

                totals = document.getElementById('totals')
                totals.innerHTML = `
                <div id="totals">
                    <p><strong>Total Calories: </strong>${totalCal} kcal</p>
                    <p><strong>Total Protein: </strong>${totalProtein}g</p>
                    <p><strong>Total Fat: </strong>${totalFat}g</p>
                    <p><strong>Total Carbs: </strong>${totalCarbs}g</p>
                </div>
                `;

                updateGoalStatus();
            }

            function clearData(){
                fetch("/clear_data");
                refreshStats();
            }

            refreshStatsBtn.addEventListener('click', refreshStats);
            clearDataBtn.addEventListener('click', clearData);

            // On page load
            window.onload = () => {
                const savedGoal = localStorage.getItem("calorieGoal");
                if (savedGoal) {
                    document.getElementById("dailyGoal").value = savedGoal;
                }
                refreshStats();
            };
        </script>

        
    </body>
</html>
